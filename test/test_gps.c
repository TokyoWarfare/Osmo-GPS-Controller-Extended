/* SPDX-License-Identifier: MIT */
/*
 * Copyright (C) 2025 SZ DJI Technology Co., Ltd.
 *  
 * All information contained herein is, and remains, the property of DJI.
 * The intellectual and technical concepts contained herein are proprietary
 * to DJI and may be covered by U.S. and foreign patents, patents in process,
 * and protected by trade secret or copyright law.  Dissemination of this
 * information, including but not limited to data and other proprietary
 * material(s) incorporated within the information, in any form, is strictly
 * prohibited without the express written consent of DJI.
 *
 * If you receive this source code without DJI’s authorization, you may not
 * further disseminate the information, and you must immediately remove the
 * source code and notify DJI of its removal. DJI reserves the right to pursue
 * legal actions against you for any loss(es) or damage(s) caused by your
 * failure to do so.
 */

#include "ble.h"
#include "esp_timer.h"
#include "esp_log.h"
#include <stdint.h>

// This is a partial set of 0x0017 GPS command frames used for testing data push functionality.
// GPS signal accuracy may be limited at this stage; the data will be refined and validated in future revisions.

// 以下为部分 0x0017 类型的 GPS 命令帧，用于测试数据推送功能。
// 由于当前 GPS 信号可能存在偏差，后续将对该数据进行进一步完善和校准。

static const uint8_t ble_test_packets[][70] = {
    {0xAA, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0xD2, 0xDD, 0x00, 0x17, 0x4F, 0x00,
     0x35, 0x01, 0x8A, 0xA5, 0x02, 0x00, 0xBC, 0xB2, 0xE9, 0x43, 0xA3, 0x4F, 0x75, 0x0D, 0xB9, 0x6D,
     0x00, 0x00, 0xDE, 0x58, 0x24, 0x41, 0x8D, 0x9A, 0xC5, 0x41, 0x00, 0x00, 0x00, 0x00, 0xE8, 0x03,
     0x00, 0x00, 0xE8, 0x03, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x63, 0xB5,
     0xD1, 0x31},
    {0xAA, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x00, 0xD1, 0x7D, 0x00, 0x17, 0x4F, 0x00,
     0x35, 0x01, 0x8B, 0xA5, 0x02, 0x00, 0xCF, 0xB2, 0xE9, 0x43, 0x91, 0x4F, 0x75, 0x0D, 0xA5, 0x6D,
     0x00, 0x00, 0x7F, 0xB4, 0x17, 0x41, 0x47, 0x67, 0xB6, 0x41, 0x00, 0x00, 0x00, 0x00, 0xE8, 0x03,
     0x00, 0x00, 0xE8, 0x03, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x0E, 0x00, 0x00, 0x00, 0xFD, 0x48,
     0x8F, 0x12},
    {0xAA, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0xD1, 0x8D, 0x00, 0x17, 0x4F, 0x00,
     0x35, 0x01, 0x8C, 0xA5, 0x02, 0x00, 0xD5, 0xB2, 0xE9, 0x43, 0xA0, 0x4F, 0x75, 0x0D, 0x86, 0x6D,
     0x00, 0x00, 0x1E, 0x33, 0x70, 0x40, 0x18, 0x67, 0x10, 0x41, 0x00, 0x00, 0x00, 0x00, 0xE8, 0x03,
     0x00, 0x00, 0xE8, 0x03, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x0E, 0x00, 0x00, 0x00, 0xC4, 0x24,
     0x26, 0xBA},
    {0xAA, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0xD0, 0x1D, 0x00, 0x17, 0x4F, 0x00,
     0x35, 0x01, 0x8D, 0xA5, 0x02, 0x00, 0xE2, 0xB2, 0xE9, 0x43, 0x8F, 0x4F, 0x75, 0x0D, 0x7E, 0x6D,
     0x00, 0x00, 0x1E, 0x33, 0xF0, 0x40, 0x18, 0x67, 0x90, 0x41, 0x00, 0x00, 0x00, 0x00, 0xE8, 0x03,
     0x00, 0x00, 0xE8, 0x03, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x0E, 0x00, 0x00, 0x00, 0xDF, 0x24,
     0xCC, 0x0D},
    {0xAA, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0xD5, 0xED, 0x00, 0x17, 0x4F, 0x00,
     0x35, 0x01, 0x8E, 0xA5, 0x02, 0x00, 0xE0, 0xB2, 0xE9, 0x43, 0xA0, 0x4F, 0x75, 0x0D, 0x71, 0x6D,
     0x00, 0x00, 0x1E, 0x33, 0xF0, 0x40, 0x18, 0x67, 0x90, 0x41, 0x00, 0x00, 0x00, 0x00, 0xE8, 0x03,
     0x00, 0x00, 0xE8, 0x03, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00, 0xD4, 0x86,
     0x2C, 0x50},
    {0xAA, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0A, 0x00, 0xD4, 0x8D, 0x00, 0x17, 0x4F, 0x00,
     0x35, 0x01, 0x90, 0xA5, 0x02, 0x00, 0xEB, 0xB2, 0xE9, 0x43, 0xA4, 0x4F, 0x75, 0x0D, 0x37, 0x6D,
     0x00, 0x00, 0x7F, 0xB4, 0x17, 0x41, 0x47, 0x67, 0xB6, 0x41, 0x00, 0x00, 0x00, 0x00, 0xE8, 0x03,
     0x00, 0x00, 0xE8, 0x03, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00, 0x85, 0x8D,
     0x2E, 0x99},
    {0xAA, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0B, 0x00, 0xD5, 0x1D, 0x00, 0x17, 0x4F, 0x00,
     0x35, 0x01, 0x91, 0xA5, 0x02, 0x00, 0xFE, 0xB2, 0xE9, 0x43, 0x8F, 0x4F, 0x75, 0x0D, 0x44, 0x6D,
     0x00, 0x00, 0x0E, 0xAB, 0xAA, 0x40, 0x30, 0x34, 0x4D, 0x41, 0x00, 0x00, 0x00, 0x00, 0xE8, 0x03,
     0x00, 0x00, 0xE8, 0x03, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x0E, 0x00, 0x00, 0x00, 0xB1, 0x1D,
     0x3A, 0xEB},
    {0xAA, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x00, 0xD7, 0x2D, 0x00, 0x17, 0x4F, 0x00,
     0x35, 0x01, 0x92, 0xA5, 0x02, 0x00, 0xDD, 0xB2, 0xE9, 0x43, 0x98, 0x4F, 0x75, 0x0D, 0x60, 0x6D,
     0x00, 0x00, 0xD9, 0xD9, 0x0B, 0xC0, 0x1B, 0x88, 0x07, 0xC2, 0x00, 0x00, 0x00, 0x00, 0xE8, 0x03,
     0x00, 0x00, 0xE8, 0x03, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x0E, 0x00, 0x00, 0x00, 0xA9, 0x42,
     0x70, 0x58},
    {0xAA, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0E, 0x00, 0xD6, 0x4D, 0x00, 0x17, 0x4F, 0x00,
     0x35, 0x01, 0xBC, 0xA5, 0x02, 0x00, 0x73, 0xB2, 0xE9, 0x43, 0x9E, 0x4F, 0x75, 0x0D, 0x71, 0x6D,
     0x00, 0x00, 0x14, 0x41, 0x90, 0x40, 0xB1, 0xDA, 0x48, 0xC2, 0x00, 0x00, 0x00, 0x00, 0xE8, 0x03,
     0x00, 0x00, 0xE8, 0x03, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x9F, 0x32,
     0xB9, 0x85},
    {0xAA, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0xDF, 0xED, 0x00, 0x17, 0x4F, 0x00,
     0x35, 0x01, 0xBE, 0xA5, 0x02, 0x00, 0xE6, 0xB1, 0xE9, 0x43, 0x73, 0x4F, 0x75, 0x0D, 0x9B, 0x6D,
     0x00, 0x00, 0xBB, 0x32, 0x13, 0x40, 0x0E, 0xF4, 0xCC, 0xC1, 0x00, 0x00, 0x00, 0x00, 0xE8, 0x03,
     0x00, 0x00, 0xE8, 0x03, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x62, 0x96,
     0x9B, 0xB4},
    {0xAA, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x12, 0x00, 0xDE, 0x8D, 0x00, 0x17, 0x4F, 0x00,
     0x35, 0x01, 0xC0, 0xA5, 0x02, 0x00, 0x37, 0xB1, 0xE9, 0x43, 0x6D, 0x4F, 0x75, 0x0D, 0xC0, 0x6D,
     0x00, 0x00, 0x50, 0x45, 0x1B, 0x40, 0x32, 0x81, 0x6E, 0xC2, 0x00, 0x00, 0x00, 0x00, 0xE8, 0x03,
     0x00, 0x00, 0xE8, 0x03, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00, 0x8A, 0xE8,
     0xF3, 0x54},
    {0xAA, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x14, 0x00, 0xDD, 0x2D, 0x00, 0x17, 0x4F, 0x00,
     0x35, 0x01, 0xC2, 0xA5, 0x02, 0x00, 0xEF, 0xAF, 0xE9, 0x43, 0x71, 0x4F, 0x75, 0x0D, 0x33, 0x6E,
     0x00, 0x00, 0xF4, 0x0E, 0xA7, 0x40, 0xA4, 0x2C, 0xE4, 0xC2, 0x00, 0x00, 0x00, 0x00, 0xE8, 0x03,
     0x00, 0x00, 0xE8, 0x03, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x0E, 0x00, 0x00, 0x00, 0x03, 0x1E,
     0x03, 0x6C},
    {0xAA, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x17, 0x00, 0xDD, 0xDD, 0x00, 0x17, 0x4F, 0x00,
     0x35, 0x01, 0xC5, 0xA5, 0x02, 0x00, 0x14, 0xAD, 0xE9, 0x43, 0x79, 0x4F, 0x75, 0x0D, 0xA8, 0x6E,
     0x00, 0x00, 0x20, 0x3F, 0x75, 0xC1, 0xC2, 0x1D, 0x6B, 0xC3, 0x00, 0x00, 0x00, 0x00, 0xE8, 0x03,
     0x00, 0x00, 0xE8, 0x03, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00, 0x76, 0xA5,
     0x12, 0x9E},
};

static const size_t num_ble_test_packets = 13;

#define TAG "BLE_TEST"

static esp_timer_handle_t ble_send_timer = NULL;
static size_t ble_test_index = 0;
static int ble_test_hz = 10;

static void ble_send_timer_callback(void* arg) {
    if (ble_test_index >= num_ble_test_packets) {
        ble_test_index = 0;
    }

    const uint8_t* data = ble_test_packets[ble_test_index];
    size_t length = sizeof(ble_test_packets[ble_test_index]);

    esp_err_t ret = ble_write_with_response(
        s_ble_profile.conn_id,
        s_ble_profile.write_char_handle,
        data,
        length
    );

    if (ret == ESP_OK) {
        ESP_LOGI(TAG, "Sent packet %zu", ble_test_index);
    } else {
        ESP_LOGE(TAG, "Failed to send packet %zu, err: 0x%x", ble_test_index, ret);
    }

    ble_test_index++;
}

// Start periodic sending; parameter specifies frequency in Hz
// 启动定时发送，参数为频率 Hz
void start_ble_packet_test(int hz) {
    if (hz <= 0) {
        ESP_LOGE(TAG, "Invalid frequency: %dHz", hz);
        return;
    }

    // If previously started, stop first before restarting
    // 如果之前启动过，先停止再重启
    if (ble_send_timer) {
        esp_timer_stop(ble_send_timer);
        esp_timer_delete(ble_send_timer);
        ble_send_timer = NULL;
    }

    ble_test_index = 0;
    ble_test_hz = hz;

    uint64_t interval_us = 1000000 / ble_test_hz;

    esp_timer_create_args_t timer_args = {
        .callback = &ble_send_timer_callback,
        .name = "ble_packet_sender"
    };

    ESP_ERROR_CHECK(esp_timer_create(&timer_args, &ble_send_timer));
    ESP_ERROR_CHECK(esp_timer_start_periodic(ble_send_timer, interval_us));

    ESP_LOGI(TAG, "Started BLE packet test sender at %d Hz (interval: %llu us)", ble_test_hz, interval_us);
}

// Optional: stop sending
// 可选：停止发送
void stop_ble_packet_test() {
    if (ble_send_timer) {
        esp_timer_stop(ble_send_timer);
        esp_timer_delete(ble_send_timer);
        ble_send_timer = NULL;
        ESP_LOGI(TAG, "Stopped BLE packet test sender");
    }
}
